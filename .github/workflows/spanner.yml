name: Spanner Build, Test, and Push

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches:
      - "**"
    tags:
      - "**"
  workflow_dispatch: {}

env:
  RUST_VERSION: "1.89" # RUST_VER
  PYTHON_VERSION: "3.12" # PY_VER

jobs:
  build-and-test-spanner:
    runs-on: ubuntu-latest

    services:
      spanner-emulator:
        image: gcr.io/cloud-spanner-emulator/emulator:1.4.0
        # expose the emulator port used in your scripts (adjust if your scripts expect other ports)
        ports:
          - 9020:9020
        options: >-
          --health-cmd="nc -z 127.0.0.1 9020 || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      # The code expects a spanner URL like:
      SYNC_SYNCSTORAGE__DATABASE_URL: spanner://projects/test-project/instances/test-instance/databases/test-database
      SYNC_SYNCSTORAGE__SPANNER_EMULATOR_HOST: 127.0.0.1:9020
      RUST_BACKTRACE: 1
      RUST_TEST_THREADS: 1

    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup-rust
        with:
          workspace-path: workflow/test-results

      - uses: ./.github/actions/setup-python
        with:
          workspace-path: workflow/test-results

      - name: Create version.json
        run: |
          printf '{"commit":"%s","version":"%s","source":"https://github.com/%s/%s","build":"%s"}\n' \
            "${{ github.sha }}" \
            "${{ github.ref_name }}" \
            "${{ github.repository_owner }}" \
            "${{ github.event.repository.name }}" \
            "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            > syncserver/version.json

      - name: Install test dependencies
        run: cargo install --locked cargo-nextest cargo-llvm-cov

      - name: Build workspace (spanner feature)
        run: |
          # Build with the spanner feature so any compile-time issues surface early
          cargo build --workspace --no-default-features --features=syncstorage-db/spanner --features=py_verifier

      - name: Wait for Spanner emulator to be ready
        run: |
          for i in {1..20}; do
            if nc -z 127.0.0.1 9020; then
              echo "Spanner emulator reachable on 127.0.0.1:9020"
              break
            fi
            echo "Waiting for Spanner emulator..."
            sleep 2
          done
          if ! nc -z 127.0.0.1 9020; then
            echo "ERROR: Cannot connect to Spanner emulator at 127.0.0.1:9020. Terminating."
            exit 1
          fi

      - name: Setup Spanner schema & instance (prepare-spanner.sh)
        env:
          SYNC_SYNCSTORAGE__DATABASE_URL: spanner://projects/test-project/instances/test-instance/databases/test-database
          SYNC_SYNCSTORAGE__SPANNER_EMULATOR_HOST: 127.0.0.1:9020
        run: |
          # your repo has scripts/prepare-spanner.sh in CircleCI â€” re-use it here
          scripts/prepare-spanner.sh

      - name: Run Spanner unit tests with coverage
        env:
          SYNC_SYNCSTORAGE__DATABASE_URL: spanner://projects/test-project/instances/test-instance/databases/test-database
          SYNC_SYNCSTORAGE__SPANNER_EMULATOR_HOST: 127.0.0.1:9020
          RUST_TEST_THREADS: 1
        run: make spanner_test_with_coverage

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: spanner-test-results
          path: workflow/test-results/

      # Upload to GCS on master
      - name: Authenticate to Google Cloud
        if: github.ref == 'refs/heads/master' && env.GCP_AUTH_KEY != ''
        env:
          GCP_AUTH_KEY: ${{ secrets.ETE_GCLOUD_SERVICE_KEY }}
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.ETE_GCLOUD_SERVICE_KEY }}

      - name: Upload JUnit results to GCS
        if: github.ref == 'refs/heads/master' && env.GCP_AUTH_KEY != ''
        env:
          GCP_AUTH_KEY: ${{ secrets.ETE_GCLOUD_SERVICE_KEY }}
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: workflow/test-results
          destination: ecosystem-test-eng-metrics/syncstorage-rs/junit
          glob: "*.xml"
          parent: false
          process_gcloudignore: false

      - name: Upload coverage results to GCS
        if: github.ref == 'refs/heads/master' && env.GCP_AUTH_KEY != ''
        env:
          GCP_AUTH_KEY: ${{ secrets.ETE_GCLOUD_SERVICE_KEY }}
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: workflow/test-results
          destination: ecosystem-test-eng-metrics/syncstorage-rs/coverage
          glob: "*.json"
          parent: false
          process_gcloudignore: false

  build-spanner-image:
    runs-on: ubuntu-latest
    needs: build-and-test-spanner

    steps:
      - uses: actions/checkout@v6

      - name: Create version.json
        run: |
          printf '{"commit":"%s","version":"%s","source":"https://github.com/%s/%s","build":"%s"}\n' \
            "${{ github.sha }}" \
            "${{ github.ref_name }}" \
            "${{ github.repository_owner }}" \
            "${{ github.event.repository.name }}" \
            "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            > syncserver/version.json

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Spanner Docker image (local artifact)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: app:build
          build-args: |
            SYNCSTORAGE_DATABASE_BACKEND=spanner
            MYSQLCLIENT_PKG=libmysqlclient-dev
          outputs: type=docker,dest=/tmp/spanner-image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v6
        with:
          name: spanner-docker-image
          path: /tmp/spanner-image.tar
          retention-days: 1

  spanner-e2e-tests:
    runs-on: ubuntu-latest
    needs: build-spanner-image

    steps:
      - uses: actions/checkout@v6

      - name: Download Docker image
        uses: actions/download-artifact@v6
        with:
          name: spanner-docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/spanner-image.tar

      - name: Create test results directory
        run: mkdir -p workflow/test-results

      - name: Run Spanner e2e tests
        run: make docker_run_spanner_e2e_tests
        env:
          SYNCSTORAGE_RS_IMAGE: app:build

      - name: Upload e2e test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: spanner-e2e-test-results
          path: workflow/test-results/

      # Upload to GCS on master
      - name: Authenticate to Google Cloud
        if: github.ref == 'refs/heads/master' && env.GCP_AUTH_KEY != ''
        env:
          GCP_AUTH_KEY: ${{ secrets.ETE_GCLOUD_SERVICE_KEY }}
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.ETE_GCLOUD_SERVICE_KEY }}

      - name: Upload e2e test results to GCS
        if: github.ref == 'refs/heads/master' && env.GCP_AUTH_KEY != ''
        env:
          GCP_AUTH_KEY: ${{ secrets.ETE_GCLOUD_SERVICE_KEY }}
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: workflow/test-results
          destination: ecosystem-test-eng-metrics/syncstorage-rs/junit
          glob: "*.xml"
          parent: false
          process_gcloudignore: false
